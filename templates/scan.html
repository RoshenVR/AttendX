{% extends "base.html" %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-6 text-center">
        <h2 class="fw-bold mb-4">Scan QR Code</h2>

        <div class="card border-0 shadow-lg bg-dark-subtle mb-4">
            <div class="card-body p-4">
                <div class="ratio ratio-1x1 bg-black rounded-3 mb-3 d-flex align-items-center justify-content-center overflow-hidden position-relative"
                    id="scanner-container">
                    <video id="qr-video" style="width: 100%; height: 100%; object-fit: cover;"></video>
                    <div class="position-absolute top-50 start-50 translate-middle text-center text-muted"
                        id="scanner-placeholder">
                        <i class="fas fa-camera fa-3x mb-2"></i>
                        <p>Camera permission required</p>
                    </div>
                    <div class="scan-overlay"></div>
                </div>

                <p class="text-muted small">Point your camera at the teacher's QR code</p>

                <div class="d-grid">
                    <button id="start-scan-btn" class="btn btn-primary" onclick="startScanner()">
                        <i class="fas fa-camera me-2"></i>Start Camera
                    </button>
                    <button id="stop-scan-btn" class="btn btn-secondary d-none" onclick="stopScanner()">
                        <i class="fas fa-stop me-2"></i>Stop Camera
                    </button>
                </div>
            </div>
        </div>

        <div class="card border-0 shadow-sm bg-dark-subtle">
            <div class="card-body">
                <h5 class="fw-bold mb-3">Manual Entry</h5>
                <form action="{{ url_for('student') }}" method="get" class="d-flex gap-2">
                    <input type="text" name="token" class="form-control bg-dark text-light border-secondary"
                        placeholder="Enter session token" required>
                    <button type="submit" class="btn btn-primary">Submit</button>
                </form>
            </div>
        </div>
    </div>
</div>

<style>
    .scan-overlay {
        position: absolute;
        top: 20%;
        left: 20%;
        width: 60%;
        height: 60%;
        border: 2px solid rgba(255, 255, 255, 0.5);
        box-shadow: 0 0 0 100rem rgba(0, 0, 0, 0.5);
        z-index: 10;
        pointer-events: none;
        border-radius: 1rem;
    }

    .scan-overlay::after {
        content: '';
        position: absolute;
        top: -2px;
        left: -2px;
        right: -2px;
        bottom: -2px;
        border: 2px solid var(--primary);
        clip-path: polygon(0 20%, 0 0, 20% 0, 100% 0, 100% 20%, 100% 80%, 100% 100%, 80% 100%, 20% 100%, 0 100%, 0 80%);
        animation: scanner-pulse 2s infinite;
    }

    @keyframes scanner-pulse {
        0% {
            opacity: 0.5;
        }

        50% {
            opacity: 1;
        }

        100% {
            opacity: 0.5;
        }
    }
</style>

<!-- Initializing QR Scanner Library -->
<script src="https://unpkg.com/@zxing/library@latest"></script>
<script>
    let codeReader;
    let selectedDeviceId;

    function startScanner() {
        codeReader = new ZXing.BrowserQRCodeReader();
        document.getElementById('scanner-placeholder').classList.add('d-none');
        document.getElementById('start-scan-btn').classList.add('d-none');
        document.getElementById('stop-scan-btn').classList.remove('d-none');

        codeReader.decodeFromInputVideoDevice(undefined, 'qr-video')
            .then((result) => {
                console.log(result);
                // The QR code content should be the full URL (e.g. http://ip:5000/student?token=123)
                // OR just the token if we generated just the token.
                // Assuming URL based on app.py: url = f"http://{SERVER_IP}:5000/student?token={token}"

                window.location.href = result.text;
            })
            .catch((err) => {
                console.error(err);
                alert("Error starting camera: " + err);
            });
    }

    function stopScanner() {
        if (codeReader) {
            codeReader.reset();
        }
        document.getElementById('scanner-placeholder').classList.remove('d-none');
        document.getElementById('start-scan-btn').classList.remove('d-none');
        document.getElementById('stop-scan-btn').classList.add('d-none');
    }
</script>
{% endblock %}